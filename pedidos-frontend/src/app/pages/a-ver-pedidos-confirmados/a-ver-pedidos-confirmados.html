<section class="container mx-auto section">
    <div class="up-page py-2 px-6 section40">
        <h2>Pedidos aprobados de {{productName}}</h2>
        <div>Bienvenido, {{nameOfUser}}</div>
    </div>
    <div class="main-page py-1">

        <a (click)="gotoListOrders()" clasS="txt14">← Volver al listado de pedidos</a>

        <h3 class="date">{{dateOfOrder}}</h3>

        <div class="flex justify-between items-center up-table section40">
            <div>
                <p><strong>Cliente: </strong>{{nameOfClient}}</p>
            </div>
            <!-- <div class="btn-generate">
                <button class="text-white font-semibold py-2 px-6 rounded-md">
                    Actualizar
                </button>
            </div> -->
        </div>
        <div class="main-table">
            <table class="table-auto w-full border-collapse text-center">
                <thead>
                    <tr class="text-white font-bold">
                        <th class="p-[15px]">Fecha</th>
                        <th class="p-[15px]">Cantidad (Tm)</th>
                        <th class="p-[15px]">Estado del pedido</th>
                        <th class="p-[15px]">Vehículo</th>
                        <th class="p-[15px]">Entregado</th>
                        <th class="p-[15px]">Acciones</th>
                    </tr>
                </thead>
                <tbody>

                    <tr *ngFor="let order of ordersPerDay">
                        <td>{{order.delivery_date | date:'dd/MM/yyyy'}}</td>
                        <td>{{order.quantity}}</td>
                        <td>
                            <span [ngClass]="{
                            'status-pending': order.status === 'pending',
                            'status-confirmed': order.status === 'confirmed',
                            'status-confirmed-elimination': order.status === 'confirmed-elimination',
                            'status-canceled': order.status === 'canceled'
                        }">
                                {{order.status === 'pending' ? 'Por confirmar' :
                                order.status === 'confirmed' ? 'Confirmado' :
                                order.status === 'confirmed-elimination' ? 'Por confirmar su cambio' :
                                order.status === 'canceled' ? 'Cancelado' : ''}}
                            </span>
                        </td>
                        <td>{{nameOfVehicle}}</td>
                        <td class="box-status">
                            <span [ngClass]="{
                            'bg-blue-200': order.is_delivered === 'por_entregar',
                            'bg-indigo-400 text-white': order.is_delivered === 'atendiendo',
                            'bg-purple-500': order.is_delivered === 'entregado',
                            'bg-red-300': order.is_delivered === 'no_entregado'
                        }">
                                {{ order.is_delivered === 'por_entregar' ? 'Por entregar' :
                                   order.is_delivered === 'atendiendo' ? 'Atendiendo' :
                                   order.is_delivered === 'entregado' ? 'Entregado' :
                                   order.is_delivered === 'no_entregado' ? 'No entregado' :
                                   order.is_delivered === null ? '' : '' }}
                            </span>
                        </td>
                        <td class="table-actions">
                          <div class="flex flex-col items-center justify-center">                                <!-- Botón Atender -->
                                <button
                                    *ngIf="order.status === 'confirmed' && order.is_delivered === 'por_entregar'"
                                    (click)="atenderPedido(order.order_id, order.order_date_id)"
                                    class="px-3 py-1 text-blue-600 hover:text-green-700 text-sm">
                                    Atender pedido
                                </button>
                                

                                <span
                                    *ngIf="order.is_delivered === 'atendiendo'"
                                    class="px-3 py-1 text-gray-700 text-sm mb-1">
                                    Detalles del chofer
                                </span>

                                <div *ngIf="showDriverInfoMap[order.order_date_id + '']"
                                    class="mt-1 text-left text-sm bg-gray-50 border rounded p-2 w-48">
                                <div><strong>Chofer:</strong> {{ order.driver_name || '-' }}</div>
                                <div><strong>Placa:</strong> {{ order.vehicle_plate || '-' }}</div>
                                </div>
                                <!-- Botón Deshacer cambio -->
                                <button
                                    *ngIf="order.status === 'confirmed' && order.is_delivered === 'atendiendo'"
                                    (click)="revertirAtencion(order.order_date_id)"
                                    class="px-3 py-1 text-orange-600 hover:text-red-700 text-sm">
                                    Deshacer cambio
                                </button>
                            </div>
          
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de atender pedido -->
    <div *ngIf="mostrarAtenderModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black opacity-50"></div>
      <div class="bg-white rounded-lg shadow-lg z-10 max-w-md w-full p-6">
        <h3 class="text-lg font-semibold mb-4">Atender pedido</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium">Placa del vehículo</label>
            <input type="text" [(ngModel)]="attendingVehiclePlate" class="w-full border rounded px-2 py-1" />
          </div>
          <div>
            <label class="block text-sm font-medium">Nombre del chofer</label>
            <input type="text" [(ngModel)]="attendingDriverName" class="w-full border rounded px-2 py-1"/>
          </div>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button (click)="cancelarAtender()" class="px-4 py-2 rounded border">Cancelar</button>
          <button (click)="confirmarAtender()" [disabled]="isSavingAtender" class="px-4 py-2 rounded bg-green-600 text-white">
            {{ isSavingAtender ? 'Guardando...' : 'Confirmar' }}
          </button>
        </div>
      </div>
    </div>

</section>